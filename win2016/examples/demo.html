<!DOCTYPE html>
<html>
<meta charset="utf-8" name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

<script src="../dist/jquery-1.11.0.min.js"></script>
<script src="../dist/fourjs-1.0.0.js"></script>
<script>window.SIGNALS = signals;</script>

<style>
html, body {
    margin: 0px; 
    overflow: hidden; 
    height: 100%;
}

.fourjs {
 height: 100%;
 position: relative;
}

.fourjs-html {
    position: absolute;
    display: none;
    z-index: 1000;
    pointer-events: none;
    top: 0px;
    left: 0px;
    bottom: 0px;
    right: 50%;
}

.fourjs-html-right {
    position: absolute;
    z-index: 1000;
    pointer-events: none;
    top: 0px;
    left: 50%;
    bottom: 0px;
    right: 0px;;
}

.fourjs-html * {
    position: relative;
    pointer-events: all;
}

.fourjs-container {
    position: relative;
    width: 100%;
    height: 100%;
}
/*--- Hide loading indicator ----*/
.loading-indicator{
    display:none !important;
}
</style>

<body>
    <div class="fourjs">
     <div class="fourjs-container"></div>
     <div class="fourjs-html"></div>
     <!-- TODO create that dynamically if stereoEnabled === true  -->
     <div class="fourjs-html-right"></div>
 </div>
 <div style='position:absolute; bottom: 0; width: 100%; text-align: center; font-family: Monospace; font-weight: bold; padding: 10px;'>
  <a href="https://github.com/DAQRI/fourjs" target="_blank">four.js</a>
  - Demo of various possibility of four.js
  <br/>
  It even works in stereo with webgl and html template support.
  <br/>
  <a href='javascript:void(0)' onclick='switchStereo()'>switch stereo</a>
</div>

<script>
function switchStereo(){
    if( location.hash.substring(1) === 'stereo' ){
        location.hash = ''
    }else{
        location.hash = 'stereo'
    }
    location.reload()
}

if( location.hash.substring(1) === 'stereo' ){
    var stereoEnabled = true
}else{
    var stereoEnabled = false
}

	//////////////////////////////////////////////////////////////////////////////////
	//		Import render loop
	//////////////////////////////////////////////////////////////////////////////////
	// array of functions for the rendering loop
	var onRenderFcts= [];
	// run the rendering loop
	var lastTimeMsec= null
	requestAnimationFrame(function animate(nowMsec){
		// keep looping
		requestAnimationFrame( animate );
		// measure time
		lastTimeMsec	= lastTimeMsec || nowMsec-1000/60
		var deltaMsec	= Math.min(200, nowMsec - lastTimeMsec)
		lastTimeMsec	= nowMsec
		// call each update function
		onRenderFcts.forEach(function(onRenderFct){
			onRenderFct(deltaMsec/1000, nowMsec/1000)
		})
	})

	//////////////////////////////////////////////////////////////////////////////////
	//		Comments
	//////////////////////////////////////////////////////////////////////////////////

        // Simulate task (not important)
        var fakeTask = { 
            app_id: 2,
            created_at: "2015-11-17T19:51:49.000Z",
            description: null,
            enterprise_id: 3,
            id: 1506,
            input_label: "Capture the Wall",
            input_options: {},
            input_type: "media",
            name: "This is the first task",
            project_id: 891,
            published_at: null,
            step_id: 849,
            threejsScene:{},
            updated_at: "2015-11-18T00:27:51.210Z"
        }
        
        // http://127.0.0.1:8080/test-pageFourjs.html#./scenes_json/scene_cube.json
        // var urlHasFile  = location.hash.slice(1) ? true : false
        // if( urlHasFile ){
        //         var sceneUrl  = location.hash.slice(1)
        //         loadSceneUrl(sceneUrl);
        // }else{
          var sceneUrl	= '../tests/scenes_json/scene_html_template.json'
          loadSceneUrl(sceneUrl);
	// }

        // Load JSON And parse it
        function loadSceneUrl(url){
            var request  = new XMLHttpRequest();
            request.onload  = function(){
                var content   = request.responseText;
                fakeTask.threejsScene  = JSON.parse(content);
                show4DTask(fakeTask);
            };
            request.open("get", url, true);
            request.send();
        }
        
        // to handle resize
        window.addEventListener('resize', function(){
            var renderer = sceneViewer.getRenderer()
            renderer.onWindowResize()
        })
        
        // Display Scene with FourJS
        FourJS.Utils.platform = 'desktop';
        var show4DTask = function(task) {
        	var sceneViewer  = FourJS.SceneViewer();
            window.sceneViewer = sceneViewer
                // Callback called when scene is loaded
                var viewerConfig ={
                   onLoad: function onSceneLoaded(scene) {
                    console.log('onSceneLoaded')
                                //////////////////////////////////////////////////////////////////////////////
                                //              init timer update to show html mirroring
                                //////////////////////////////////////////////////////////////////////////////
                                
                                setTimeout(function(){  // FIXME why this setTimeout is needed ???
                                    var domElement = document.createElement('span')
                                    document.querySelector('.fourjs-html').appendChild(domElement)
                                    setInterval(function(){
                                        domElement.innerHTML = 'Timestamp: '+Date.now();
                                    }, 100)
                                }, 1)
                            }
                        };

                        viewerConfig.domElement = document.querySelectorAll(".fourjs-container");
                        viewerConfig.debugLevel = 2;
                        viewerConfig.showGrid = true;
                        viewerConfig.showTarget = true;
                        viewerConfig.showScanningIndicator = false;
                        viewerConfig.platform = "desktop";

                        if( stereoEnabled ){
                            viewerConfig.stereoEnabled      = true
                        }

                        sceneViewer.initialize(viewerConfig);

                        sceneViewer.load({
                            task: task,
                            orbitControls: true,
                            showGrid: true
                        });
                    };
                </script></body>
                </html>